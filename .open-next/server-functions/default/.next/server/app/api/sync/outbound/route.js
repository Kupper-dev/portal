(()=>{var e={};e.id=342,e.ids=[342],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},4688:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>h,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>d});var s={};r.r(s),r.d(s,{POST:()=>u});var o=r(2706),n=r(8203),a=r(5994),i=r(9187),c=r(8441);async function u(){try{let e=await (0,c.vi)();return i.NextResponse.json({success:!0,result:e})}catch(e){return console.error("Outbound Sync Error:",e),i.NextResponse.json({success:!1,error:e.message},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/sync/outbound/route",pathname:"/api/sync/outbound",filename:"route",bundlePath:"app/api/sync/outbound/route"},resolvedPagePath:"/Users/usuario/Desktop/Kupper/Dev/portal/src/app/api/sync/outbound/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:d,serverHooks:h}=p;function f(){return(0,a.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:d})}},6487:()=>{},8335:()=>{},8441:(e,t,r)=>{"use strict";r.d(t,{Cv:()=>c,vi:()=>l,UG:()=>p});var s=r(7752);let o=()=>{let e="https://rrqbzanpgtxljdpcaakg.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase environment variables");return(0,s.UU)(e,t,{auth:{persistSession:!1}})},n={customers:{appId:process.env.PODIO_APP_ID_CUSTOMERS,appToken:process.env.PODIO_APP_TOKEN_CUSTOMERS},students:{appId:process.env.PODIO_APP_ID_STUDENTS,appToken:process.env.PODIO_APP_TOKEN_STUDENTS}};class a{constructor(e){this.accessToken=null,this.apiBase="https://api.podio.com",this.authType=e.authType,this.clientId=e.clientId,this.clientSecret=e.clientSecret}async authenticateWithApp(e,t){let r=new URLSearchParams({grant_type:"app",app_id:e.toString(),app_token:t,client_id:this.clientId,client_secret:this.clientSecret}),s=await fetch(`${this.apiBase}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(!s.ok){let e=await s.text();throw Error(`Podio Auth Failed: ${s.status} ${e}`)}let o=await s.json();this.accessToken=o.access_token}async request(e,t,r){if(!this.accessToken)throw Error("Not authenticated");let s=t.startsWith("/")?t:`/${t}`,o=`${this.apiBase}${s}`,n={method:e,headers:{Authorization:`OAuth2 ${this.accessToken}`,"Content-Type":"application/json"}};r&&(n.body=JSON.stringify(r));let a=await fetch(o,n);if(204!==a.status&&(200!==a.status||"0"!==a.headers.get("content-length"))){if(!a.ok){let t=await a.text();try{let r=JSON.parse(t);if("GET"===e&&404===a.status)return null;throw{body:r,status:a.status}}catch(e){if(404===a.status)return null;throw Error(`Podio Request Failed: ${a.status} ${t}`)}}return await a.json()}}}async function i(e){let t="customers"===e?process.env.PODIO_APP_ID_CUSTOMERS:process.env.PODIO_APP_ID_STUDENTS,r="customers"===e?process.env.PODIO_APP_TOKEN_CUSTOMERS:process.env.PODIO_APP_TOKEN_STUDENTS;if(!t||!r)throw Error(`Missing configuration for Podio App: ${e}`);if(!process.env.PODIO_CLIENT_ID||!process.env.PODIO_CLIENT_SECRET)throw Error("Missing PODIO_CLIENT_ID or PODIO_CLIENT_SECRET");let s=new a({authType:"app",clientId:process.env.PODIO_CLIENT_ID,clientSecret:process.env.PODIO_CLIENT_SECRET});return await s.authenticateWithApp(parseInt(t),r),s}async function c(e,t){console.log(`Verifying hook ${e} with code ${t}...`);try{let r=await i("customers");return await r.request("POST",`/hook/${e}/verify/validate`,{code:t}),console.log(`Hook ${e} verified successfully.`),!0}catch(r){console.error(`Failed to verify hook ${e}:`,r);try{let r=await i("students");return await r.request("POST",`/hook/${e}/verify/validate`,{code:t}),console.log(`Hook ${e} verified successfully (via Students App).`),!0}catch(t){throw console.error(`Failed to verify hook ${e} with Students App too:`,t),r}}}async function u(e){try{let t=await i("customers"),r=await t.request("GET",`/item/${e}`);if(r)return{app:"customers",data:r}}catch(e){console.error("Error fetching from Customers:",e)}try{let t=await i("students"),r=await t.request("GET",`/item/${e}`);if(r)return{app:"students",data:r}}catch(e){console.error("Error fetching from Students:",e)}return console.warn(`Could not fetch Podio Item ${e} from configured Apps.`),null}async function p(e,t){let r=o();console.log(`Syncing Podio Item ${e} to Supabase...`);let s=await u(e);if(!s){console.error(`Item ${e} not found in supported Apps.`);return}let{app:n,data:a}=s;console.log(`Identified Item ${e} as ${n}`);let i=function(e,t){let r=e=>{let r=t.fields.find(t=>t.external_id===e);return r?.values?.[0]?.value||null},s={podio_item_id:t.item_id,name:r("title")||t.title,last_updated_at:new Date().toISOString(),sync_status:"synced"};"customers"===e?(s.email=r("email"),s.recipient=r("recipient"),s.phone=r("phone"),s.address=r("address"),s.whatsapp=r("whatsapp"),s.type=(e=>{let r=t.fields.find(t=>t.external_id===e);return r?.values?.[0]?.value?.id||null})("type")):s.email=r("email");let o=r("auth0-id");return o&&(s.auth0_id=o),s}(n,a),{error:c}=await r.from(n).upsert(i,{onConflict:"podio_item_id"});c?console.error(`Error syncing to Supabase table ${n}:`,c):console.log(`Successfully synced Item ${e} to ${n}.`)}async function l(){let e=o();for(let t of(console.log("Starting Outbound Sync..."),["customers","students"])){let{data:r,error:s}=await e.from(t).select("*").eq("sync_status","pending");if(s){console.error(`Error fetching pending ${t}:`,s);continue}for(let s of r||[])try{console.log(`Syncing ${t} item ${s.id} to Podio...`);let r=await d(t,s,s.podio_item_id);await e.from(t).update({sync_status:"synced",podio_item_id:r,last_updated_at:new Date().toISOString()}).eq("id",s.id),console.log(`Synced ${t} item ${s.id}. Podio ID: ${r}`)}catch(r){console.error(`Failed to sync ${t} item ${s.id}:`,r),await e.from(t).update({sync_status:"failed"}).eq("id",s.id)}}}async function d(e,t,r){try{let s=await i(e),o=parseInt(n[e].appId),a={};if(t.name&&(a.title=t.name),t.email&&(a.email=[{type:"work",value:t.email}]),r)return await s.request("PUT",`/item/${r}`,{fields:a}),r;return(await s.request("POST",`/app/${o}/item`,{fields:a})).item_id}catch(t){throw console.error(`Error pushing to Podio (${e}):`,t?.body||t),t}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,452,752],()=>r(4688));module.exports=s})();