(()=>{var e={};e.id=136,e.ids=[136],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},2411:(e,t,o)=>{"use strict";o.r(t),o.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>h,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>d});var s={};o.r(s),o.d(s,{POST:()=>u});var r=o(2706),a=o(8203),i=o(5994),n=o(9187),c=o(8441);async function u(e){try{let t=await e.json(),{type:o,hook_id:s,code:r,item_id:a}=t;if(console.log(`Received Podio Webhook: ${o}`,t),"hook.verify"===o)return await (0,c.Cv)(s,r),n.NextResponse.json({message:"Verified"},{status:200});if("item.create"===o||"item.update"===o)return await (0,c.UG)(a,o),n.NextResponse.json({message:"Synced"},{status:200});return n.NextResponse.json({message:"Ignored type"},{status:200})}catch(e){return console.error("Podio Webhook Error:",e),n.NextResponse.json({error:e.message},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhooks/podio/route",pathname:"/api/webhooks/podio",filename:"route",bundlePath:"app/api/webhooks/podio/route"},resolvedPagePath:"/Users/usuario/Desktop/Kupper/Dev/portal/src/app/api/webhooks/podio/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:d,serverHooks:h}=p;function f(){return(0,i.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:d})}},6487:()=>{},8335:()=>{},8441:(e,t,o)=>{"use strict";o.d(t,{Cv:()=>c,vi:()=>l,UG:()=>p});var s=o(7752);let r=()=>{let e="https://rrqbzanpgtxljdpcaakg.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase environment variables");return(0,s.UU)(e,t,{auth:{persistSession:!1}})},a={customers:{appId:process.env.PODIO_APP_ID_CUSTOMERS,appToken:process.env.PODIO_APP_TOKEN_CUSTOMERS},students:{appId:process.env.PODIO_APP_ID_STUDENTS,appToken:process.env.PODIO_APP_TOKEN_STUDENTS}};class i{constructor(e){this.accessToken=null,this.apiBase="https://api.podio.com",this.authType=e.authType,this.clientId=e.clientId,this.clientSecret=e.clientSecret}async authenticateWithApp(e,t){let o=new URLSearchParams({grant_type:"app",app_id:e.toString(),app_token:t,client_id:this.clientId,client_secret:this.clientSecret}),s=await fetch(`${this.apiBase}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});if(!s.ok){let e=await s.text();throw Error(`Podio Auth Failed: ${s.status} ${e}`)}let r=await s.json();this.accessToken=r.access_token}async request(e,t,o){if(!this.accessToken)throw Error("Not authenticated");let s=t.startsWith("/")?t:`/${t}`,r=`${this.apiBase}${s}`,a={method:e,headers:{Authorization:`OAuth2 ${this.accessToken}`,"Content-Type":"application/json"}};o&&(a.body=JSON.stringify(o));let i=await fetch(r,a);if(204!==i.status&&(200!==i.status||"0"!==i.headers.get("content-length"))){if(!i.ok){let t=await i.text();try{let o=JSON.parse(t);if("GET"===e&&404===i.status)return null;throw{body:o,status:i.status}}catch(e){if(404===i.status)return null;throw Error(`Podio Request Failed: ${i.status} ${t}`)}}return await i.json()}}}async function n(e){let t="customers"===e?process.env.PODIO_APP_ID_CUSTOMERS:process.env.PODIO_APP_ID_STUDENTS,o="customers"===e?process.env.PODIO_APP_TOKEN_CUSTOMERS:process.env.PODIO_APP_TOKEN_STUDENTS;if(!t||!o)throw Error(`Missing configuration for Podio App: ${e}`);if(!process.env.PODIO_CLIENT_ID||!process.env.PODIO_CLIENT_SECRET)throw Error("Missing PODIO_CLIENT_ID or PODIO_CLIENT_SECRET");let s=new i({authType:"app",clientId:process.env.PODIO_CLIENT_ID,clientSecret:process.env.PODIO_CLIENT_SECRET});return await s.authenticateWithApp(parseInt(t),o),s}async function c(e,t){console.log(`Verifying hook ${e} with code ${t}...`);try{let o=await n("customers");return await o.request("POST",`/hook/${e}/verify/validate`,{code:t}),console.log(`Hook ${e} verified successfully.`),!0}catch(o){console.error(`Failed to verify hook ${e}:`,o);try{let o=await n("students");return await o.request("POST",`/hook/${e}/verify/validate`,{code:t}),console.log(`Hook ${e} verified successfully (via Students App).`),!0}catch(t){throw console.error(`Failed to verify hook ${e} with Students App too:`,t),o}}}async function u(e){try{let t=await n("customers"),o=await t.request("GET",`/item/${e}`);if(o)return{app:"customers",data:o}}catch(e){console.error("Error fetching from Customers:",e)}try{let t=await n("students"),o=await t.request("GET",`/item/${e}`);if(o)return{app:"students",data:o}}catch(e){console.error("Error fetching from Students:",e)}return console.warn(`Could not fetch Podio Item ${e} from configured Apps.`),null}async function p(e,t){let o=r();console.log(`Syncing Podio Item ${e} to Supabase...`);let s=await u(e);if(!s){console.error(`Item ${e} not found in supported Apps.`);return}let{app:a,data:i}=s;console.log(`Identified Item ${e} as ${a}`);let n=function(e,t){let o=e=>{let o=t.fields.find(t=>t.external_id===e);return o?.values?.[0]?.value||null},s={podio_item_id:t.item_id,name:o("title")||t.title,last_updated_at:new Date().toISOString(),sync_status:"synced"};"customers"===e?(s.email=o("email"),s.recipient=o("recipient"),s.phone=o("phone"),s.address=o("address"),s.whatsapp=o("whatsapp"),s.type=(e=>{let o=t.fields.find(t=>t.external_id===e);return o?.values?.[0]?.value?.id||null})("type")):s.email=o("email");let r=o("auth0-id");return r&&(s.auth0_id=r),s}(a,i),{error:c}=await o.from(a).upsert(n,{onConflict:"podio_item_id"});c?console.error(`Error syncing to Supabase table ${a}:`,c):console.log(`Successfully synced Item ${e} to ${a}.`)}async function l(){let e=r();for(let t of(console.log("Starting Outbound Sync..."),["customers","students"])){let{data:o,error:s}=await e.from(t).select("*").eq("sync_status","pending");if(s){console.error(`Error fetching pending ${t}:`,s);continue}for(let s of o||[])try{console.log(`Syncing ${t} item ${s.id} to Podio...`);let o=await d(t,s,s.podio_item_id);await e.from(t).update({sync_status:"synced",podio_item_id:o,last_updated_at:new Date().toISOString()}).eq("id",s.id),console.log(`Synced ${t} item ${s.id}. Podio ID: ${o}`)}catch(o){console.error(`Failed to sync ${t} item ${s.id}:`,o),await e.from(t).update({sync_status:"failed"}).eq("id",s.id)}}}async function d(e,t,o){try{let s=await n(e),r=parseInt(a[e].appId),i={};if(t.name&&(i.title=t.name),t.email&&(i.email=[{type:"work",value:t.email}]),o)return await s.request("PUT",`/item/${o}`,{fields:i}),o;return(await s.request("POST",`/app/${r}/item`,{fields:i})).item_id}catch(t){throw console.error(`Error pushing to Podio (${e}):`,t?.body||t),t}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[638,452,752],()=>o(2411));module.exports=s})();